---
# configure_node_networking.yml
- name: Configure networking for Kubernetes nodes
  hosts: k8s_cluster
  become: true
  gather_facts: true

  tasks:
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts with node's own entry
      lineinfile:
        path: /etc/hosts
        line: "127.0.1.1 {{ inventory_hostname }}"
        regexp: "^127.0.1.1"
        state: present

    - name: Set node type facts
      set_fact:
        is_control_plane: "{{ inventory_hostname in (groups['control_plane_nodes'] | default([])) }}"
        is_worker: "{{ inventory_hostname in (groups['worker_nodes'] | default([])) }}"
        is_raspberry_pi: "{{ inventory_hostname in (groups['raspberry_pis'] | default([])) }}"
        is_ms01: "{{ inventory_hostname in (groups['ms-01s'] | default([])) }}"

    # Interface detection for MS-01 worker nodes
    - name: Get network interface names (MS-01 only)
      shell: |
        ip -br link | grep -E 'enp[0-9]' | awk '{print $1}'
      register: interfaces_output
      changed_when: false
      when: is_ms01

    - name: Identify I226-LM interface (MS-01 only)
      shell: |
        find /sys/class/net -name eth* -o -name enp* | sort | xargs -I{} sh -c 'if grep -q I226-LM /sys/class/net/{}/device/uevent 2>/dev/null; then echo {}; fi' | sed 's/\/sys\/class\/net\///'
      register: mgmt_interface
      changed_when: false
      failed_when: false
      when: is_ms01

    - name: Use alternative method if I226-LM not found
      shell: |
        ethtool -i $(ip -br link | grep -E 'enp[0-9]' | awk '{print $1}') 2>/dev/null | grep -B1 I226-LM | head -1 | awk '{print $2}'
      register: mgmt_interface_alt
      changed_when: false
      failed_when: false
      when: is_ms01 and (mgmt_interface.stdout_lines|length == 0)

    - name: Combine interface detection results
      set_fact:
        mgmt_if: "{{ mgmt_interface.stdout_lines|first if mgmt_interface.stdout_lines else mgmt_interface_alt.stdout if mgmt_interface_alt.stdout else 'enp9s0' }}"
      when: is_ms01

    - name: Identify I226-V interface (MS-01 only)
      shell: |
        find /sys/class/net -name eth* -o -name enp* | sort | xargs -I{} sh -c 'if grep -q I226-V /sys/class/net/{}/device/uevent 2>/dev/null; then echo {}; fi' | sed 's/\/sys\/class\/net\///'
      register: second_interface
      changed_when: false
      failed_when: false
      when: is_ms01

    - name: Use alternative method if I226-V not found
      shell: |
        ethtool -i $(ip -br link | grep -E 'enp[0-9]' | awk '{print $1}') 2>/dev/null | grep -B1 I226-V | head -1 | awk '{print $2}'
      register: second_interface_alt
      changed_when: false
      failed_when: false
      when: is_ms01 and (second_interface.stdout_lines|length == 0)

    - name: Combine interface detection results for I226-V
      set_fact:
        second_if: "{{ second_interface.stdout_lines|first if second_interface.stdout_lines else second_interface_alt.stdout if second_interface_alt.stdout else 'enp8f0' }}"
      when: is_ms01

    - name: Identify X710 SFP+ interfaces (MS-01 only)
      shell: |
        find /sys/class/net -name eth* -o -name enp* | sort | xargs -I{} sh -c 'if grep -q X710 /sys/class/net/{}/device/uevent 2>/dev/null; then echo {}; fi' | sed 's/\/sys\/class\/net\///'
      register: sfp_interfaces
      changed_when: false
      failed_when: false
      when: is_ms01

    - name: Use alternative method if X710 not found
      shell: |
        ip -br link | grep -E 'enp[0-9]' | grep -v "$(echo {{ mgmt_if }})" | grep -v "$(echo {{ second_if }})" | awk '{print $1}'
      register: sfp_interfaces_alt
      changed_when: false
      failed_when: false
      when: is_ms01 and (sfp_interfaces.stdout_lines|length == 0)

    - name: Combine interface detection results for SFP+
      set_fact:
        sfp_ifs: "{{ sfp_interfaces.stdout_lines if sfp_interfaces.stdout_lines else sfp_interfaces_alt.stdout_lines }}"
      when: is_ms01

    - name: Display identified interfaces (MS-01 only)
      debug:
        msg: |
          Management interface (I226-LM): {{ mgmt_if }}
          Secondary interface (I226-V): {{ second_if }}
          SFP+ interfaces: {{ sfp_ifs }}
      when: is_ms01

    # Create netplan for Raspberry Pi nodes
    - name: Create netplan configuration for Raspberry Pi nodes
      copy:
        dest: /etc/netplan/60-k8s-network.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              eth0:
                dhcp4: no
                addresses:
                  - {{ hostvars[inventory_hostname]['ansible_host'] }}{{ control_subnet_mask }}  # Control plane IP
                routes:
                  - to: default
                    via: {{ control_plane_gateway }}
                nameservers:
                  addresses: [{{ control_plane_gateway }}, 1.1.1.1, 1.0.0.1]  # UDM-Pro first, then Cloudflare
        mode: '0644'
      register: netplan_config_rpi
      when: is_raspberry_pi

    # Create netplan for MS-01 worker nodes
    - name: Create netplan configuration for MS-01 worker nodes
      copy:
        dest: /etc/netplan/60-k8s-network.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              {{ mgmt_if }}:
                dhcp4: no
                addresses:
                  - 10.8.16.{{ hostvars[inventory_hostname]['ansible_host'] | regex_replace('^.*\\.', '') }}{{ mgmt_subnet_mask }}  # Management IP
                  - {{ hostvars[inventory_hostname]['ansible_host'] }}{{ control_subnet_mask }}  # Control plane IP
                routes:
                  - to: default
                    via: {{ admin_gateway }}
                nameservers:
                  addresses: [{{ admin_gateway }}, 1.1.1.1]
              {{ second_if }}:
                dhcp4: no
                optional: true
              {% for interface in sfp_ifs %}
              {{ interface }}:
                dhcp4: no
                optional: true
                mtu: 9000
                addresses:
                  - 10.8.28.{{ hostvars[inventory_hostname]['ansible_host'] | regex_replace('^.*\\.', '') }}{{ pod_subnet_mask }}  # Pod network
                  - 10.8.38.{{ hostvars[inventory_hostname]['ansible_host'] | regex_replace('^.*\\.', '') }}{{ service_subnet_mask }}  # Service network
                  - 10.8.48.{{ hostvars[inventory_hostname]['ansible_host'] | regex_replace('^.*\\.', '') }}{{ storage_subnet_mask }}  # Storage network
              {% endfor %}
        mode: '0644'
      register: netplan_config_ms01
      when: is_ms01

    # Add hosts entries for all nodes
    - name: Add K8s cluster hosts to /etc/hosts
      blockinfile:
        path: /etc/hosts
        block: |
          # Gateways
          {{ control_plane_gateway }} control-pane-gateway
          {{ admin_gateway }} admin-network-gateway

          # Control plane nodes
          10.8.18.86 k8s-cp-01
          10.8.18.87 k8s-cp-02
          10.8.18.88 k8s-cp-03

          # Worker nodes
          10.8.18.90 k8s-ms01-node-01
          10.8.18.91 k8s-ms01-node-02
          10.8.16.90 k8s-ms01-node-01-mgmt
          10.8.16.91 k8s-ms01-node-02-mgmt

          # Admin node
          10.8.16.85 k8s-admin

          # Virtual IP for HA control plane
          {{ k8s_api_vip }} k8s-apiserver
        marker: "# {mark} KUBERNETES NODES"
        state: present

    # Apply netplan configuration
    - name: Check netplan syntax
      command: netplan generate
      register: netplan_generate
      changed_when: false
      failed_when: netplan_generate.rc != 0
      when: (netplan_config_rpi is defined and netplan_config_rpi.changed) or (netplan_config_ms01 is defined and netplan_config_ms01.changed)

    - name: Apply netplan configuration if syntax is valid
      command: netplan apply
      when: (netplan_config_rpi is defined and netplan_config_rpi.changed and netplan_generate.rc == 0) or (netplan_config_ms01 is defined and netplan_config_ms01.changed and netplan_generate.rc == 0)

    - name: Wait for network to stabilize
      wait_for_connection:
        delay: 5
        timeout: 60
      when: (netplan_config_rpi is defined and netplan_config_rpi.changed and netplan_generate.rc == 0) or (netplan_config_ms01 is defined and netplan_config_ms01.changed and netplan_generate.rc == 0)

    # Verification steps
    - name: Show effective IP configuration
      shell: "{% if is_raspberry_pi %}ip addr show eth0{% else %}ip -br addr | grep -v lo{% endif %}"
      register: ip_config
      changed_when: false

    - name: Display IP configuration
      debug:
        msg: "{{ ip_config.stdout_lines }}"

    - name: Test DNS resolution
      command: nslookup cloudflare.com
      register: dns_test
      changed_when: false
      failed_when: false

    - name: Display DNS test results
      debug:
        msg: "{{ dns_test.stdout_lines }}"